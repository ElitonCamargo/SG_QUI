
        <h2>Compostos Químicos</h2>
    <table id="tabela-composto" class="table table-striped">
        <thead>
            <tr>
                <th>Código</th>
                <th>Nome</th>
                <th>Fórmula</th>
            </tr>
        </thead>
        <tbody>
            <!-- Os elementos serão preenchidos aqui dinamicamente -->
        </tbody>
    </table>


      
      <!-- Modal -->
      <div class="modal fade" id="modalDetalhes" tabindex="-1" aria-labelledby="modalDetalhesLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
          <div class="modal-content">                        
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="modalDetalhesLabel">Compostos Químico</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>            
            <div class="modal-body">
              <div class="container">

                <div class="row justify-content-end">
                  <div class="col-md-2 text-end">
                    <div class="btn-group" role="group" aria-label="Basic example">
                      <button type="button" class="btn btn btn-primary btn-sm me-2" id="btnSalvarEdicao" disabled><i style="font-size: 1.2rem;" class="bi bi-floppy"></i></button>
                      <button type="button" class="btn btn-secondary btn-sm" id="btnLiberarEdicao"><i style="font-size: 1.2rem;" class="bi bi-pencil-square"></i></button>         
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <input type="text" class="form-control" id="modal-compostoId" style="display: none;">
                      <label for="modal-nome" class="form-label">Nome:</label>
                      <input type="text" class="form-control" id="modal-nome" disabled>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="modal-simbolo" class="form-label">Formúla:</label>
                      <input type="text" class="form-control" id="modal-formula" disabled>
                    </div>
                  </div>
                  <div class="col-md-12">
                    <div class="mb-3">
                      <label for="modal-numero-atomico" class="form-label">Descrição:</label>
                      <textarea class="form-control" id="modal-descricao" rows="3" disabled></textarea>
                    </div>
                  </div>
                </div>
                <!-- <div id="addGarantias" style="display: none;"> -->
<div class="modal-header">
</div>
<h1 class="modal-title fs-5 mb-3" id="modalDetalhesLabel">Adicionar garantias</h1>
<div>
  <table class="table" id="tabela-garantias">    
    <thead>
      <tr>
        <th scope="col">Elemento</th>
        <th scope="col">Percentual</th>
      </tr>
      <tr>        
        <th scope="col">
          <div class="input-group ">
            <input type="text" id="inputBusca" class="form-control" placeholder="Digite para filtrar..." autocomplete="off">
          </div>
          <div id="listaItens" class="list-group" style="display: none; position: absolute; width: 35%;"></div>
          <input type="text" id="modal-elementoId" style="display: none;">
        </th>
        <th scope="col">
          <div class="input-group ">
            <input type="text" id="inputPercentual" class="form-control" placeholder="%">
          </div>
        </th>
        <th>          
          <div class="input-group">
            <button type="submit" class="btn btn-primary btn-sm" id="btnCadastrarGarantia"><i style="font-size: 1.1rem;" class="bi bi-floppy"></i></button>
          </div>  
        </th>
      </tr>
    </thead>
    <tbody>
      
      <!-- Adicione mais linhas conforme necessário -->
    </tbody>
  </table>

</div>




              </div>
            </div>
          </div>
        </div>
      </div>
      
      

<script>
    
    $('#btnLiberarEdicao').on('click',()=>{
        // Habilitar ou desabilitar os inputs com base no estado atual
        let inputs = $('#modalDetalhes input, #modalDetalhes textarea');
        let disabled = inputs.prop('disabled');          
        inputs.prop('disabled', !disabled);
        $('#btnSalvarEdicao').prop('disabled', !disabled);

        // Alterar o estilo do botão de liberação de edição
        if (disabled) {
          $('#btnLiberarEdicao').removeClass('btn-secondary').addClass('btn-success');
        } else {
          $('#btnLiberarEdicao').removeClass('btn-success').addClass('btn-secondary');
        }
    });

    $(document).ready(()=>{
        const addLinha = (id,nome,formula) => {
            return `
                <tr>
                    <td>${id}</td>
                    <td>${nome}</td>
                    <td>${formula}</td>
                    <td>
                        <button type="button" class="btn btn-primary btn-sm" onclick="buscarCompostoPorId('${id}')"><i style="font-size: 1.2rem;" class="bi bi-binoculars-fill"></i></button>
                        <button type="button" class="btn btn-danger btn-sm"><i style="font-size: 1.2rem;" class="bi bi-trash"></i></button>
                    </td>
                </tr>                
            `;
        };

        req_GET("http://localhost:3000/composto").then(data => {
            const tabela = $('#tabela-composto tbody');
            data.forEach(composto => {
                    tabela.append(addLinha(composto.id,composto.nome,composto.formula,composto.descricao));
                }
            );            
        })
        .catch(error => {
            console.error('Erro ao fazer solicitação GET:', error);
        });
  });

  const buscarGarantiaComposto = async (composto_id, callback)=>{
    req_GET(`http://localhost:3000/garantia?composto=${composto_id}`).then(garantias => {
      callback(garantias);
    })
    .catch(error => {
        console.error('Erro ao fazer solicitação GET:', error);
        callback(error);
    });
  }


  const buscarCompostoPorId = async (id)=>{

    const addLinha = (id_garantia,id_elemento,id_composto,elemento, percentual) => {
        return `
            <tr>
                
                <td>${elemento}</td>
                <td>${percentual}%</td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm"><i style="font-size: 1.2rem;" class="bi bi-trash"></i></button>
                </td>
            </tr>                
        `;
    };


    req_GET(`http://localhost:3000/composto/${id}`).then(composto => {
          $('#modal-compostoId').val(composto.id);
          $('#modal-nome').val(composto.nome);
          $('#modal-formula').val(composto.formula);
          $('#modal-descricao').val(composto.descricao);
          // Exibir o modal
          buscarGarantiaComposto(id,(garantias)=>{
            req_GET(`http://localhost:3000/elemento`).then(elementos =>{
              globalElementos = elementos;
              garantias.map(garantia =>{
                garantia.elemento = elementos.find(elemento => elemento.id == garantia.elemento)                 
              })
              const tabela = $('#tabela-garantias tbody');
              tabela.html("");
              let total = 0;
              garantias.forEach(garantia => {
                total += parseFloat(garantia.percentual);
                tabela.append(addLinha(garantia.id, garantia.elemento.id,garantia.composto,garantia.elemento.nome, garantia.percentual));
              });
              tabela.append(`<tr><th>Total</th><th>${total}%</th>`);
            })
          });
          $('#modalDetalhes').modal('show');
    })
    .catch(error => {
        console.error('Erro ao fazer solicitação GET:', error);
    });
  }


  // ******************************************
  let globalElementos;
  $(document).ready(function() {

  // Função para atualizar a lista de itens com base no texto digitado
  function atualizarLista(texto) {
    // Limpa a lista de itens
    $('#listaItens').empty();
    // Filtra os itens que correspondem ao texto digitado
    const itensFiltrados = globalElementos.filter(function(item) {
      return item.nome.toLowerCase().includes(texto.toLowerCase());
    });
    // Adiciona os itens filtrados à lista
    itensFiltrados.forEach(function(item) {
      $('#listaItens').append(`<a href="#" class="list-group-item list-group-item-action" style="font-weight: 400;" value="${item.id}">${item.nome}</a>`);
    });
    // Exibe a lista de itens se houver itens filtrados, caso contrário, oculta-a
    if (itensFiltrados.length > 0 && texto.length > 0) {
      $('#listaItens').show();
    } else {
      $('#listaItens').hide();
    }
  }

  // Evento de tecla pressionada no campo de entrada
  $('#inputBusca').on('input', function() {    
    const textoDigitado = $(this).val();
    atualizarLista(textoDigitado);
  });

  // Evento de clique em um item da lista
  $('#listaItens').on('click', '.list-group-item', function() {
    // Atualiza o valor do campo de entrada com o texto do item clicado
    $('#modal-elementoId').val($(this).attr('value'));
    const textoItem = $(this).text();
    $('#inputBusca').val(textoItem);
    // Oculta a lista de itens
    $('#listaItens').hide();
  });
});

const garantiaCadastrar = async (dados)=>{    
  let result = await req_POST("http://localhost:3000/garantia", dados);
  return result;
}

$("#btnCadastrarGarantia").on('click',()=>{
  const dados ={
    composto    : $('#modal-compostoId').val(),
    elemento    : $('#modal-elementoId').val(),
    percentual  : $('#inputPercentual').val()
  }
  let result = garantiaCadastrar(dados);
  console.log(result);
  if(result){
    buscarCompostoPorId(dados.composto);
    $('#modal-compostoId').val("");
    $('#modal-elementoId').val("");
    $('#inputPercentual').val("");
    $('#inputBusca').val("");

  }
})

</script>